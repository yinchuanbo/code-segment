<!DOCTYPE html>
            <html lang="en">
              <head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <title>å®ç°æŠ–éŸ³ â€œè§†é¢‘æ— é™æ»‘åŠ¨â€œæ•ˆæœ</title>
                <link rel=icon href="./imgs/code.svg" sizes=32x32>
                <link rel="stylesheet" href="./css/prism.css">
                <link rel="stylesheet" type="text/css" href="./css/style.css" />
              </head>
              <body>
                <div class="container">
                  <div class="container-header">
                    <span onclick="location.href='/'"></span>
                    <h2>å®ç°æŠ–éŸ³ â€œè§†é¢‘æ— é™æ»‘åŠ¨â€œæ•ˆæœ</h2>
                    <p>2024-07-25 16:35:17 Â· YinHao</p>
                  </div>
                  <div class="container-main"><h1>æœ€ç»ˆæ•ˆæœ</h1>
<p>åœ¨çº¿é¢„è§ˆï¼š<a href="https://dy.ttentau.top/">dy.ttentau.top/</a></p>
<p>Github åœ°å€ï¼š<a href="https://github.com/zyronon/douyin">github.com/zyronon/douâ€¦</a></p>
<p>æºç ï¼š<a href="https://github.com/zyronon/douyin/blob/master/src/components/slide/SlideVerticalInfinite.vue">SlideVerticalInfinite.vue</a></p>
<h1>å®ç°åŸç†</h1>
<p>æ— é™æ»‘åŠ¨çš„åŸç†å’Œè™šæ‹Ÿæ»šåŠ¨çš„åŸç†å·®ä¸å¤šï¼Œè¦ä¿æŒ <code>SlideList</code> é‡Œé¢æ°¸è¿œåªæœ‰ <code>N</code> ä¸ª <code>SlideItem</code>ï¼Œå°±è¦åœ¨æ»‘åŠ¨æ—¶ä¸æ–­çš„åˆ é™¤å’Œå¢åŠ  <code>SlideItem</code>ã€‚
æ»‘åŠ¨æ—¶è°ƒæ•´ <code>SlideList</code> çš„åç§»é‡ <code>translateY</code> çš„å€¼ï¼Œä»¥åŠåˆ—è¡¨é‡Œé‚£å‡ ä¸ª <code>SlideItem</code> çš„ <code>top</code> å€¼ï¼Œå°±å¯ä»¥äº†</p>
<p>ä¸ºä»€ä¹ˆè¦è°ƒæ•´ <code>SlideList</code> çš„åç§»é‡ <code>translateY</code> çš„å€¼åŒæ—¶è¿˜è¦è°ƒæ•´ <code>SlideItem</code> çš„ <code>top</code> å€¼å‘¢ï¼Ÿ
å› ä¸º <code>translateY</code> åªæ˜¯å°†æ•´ä¸ªåˆ—è¡¨ç§»åŠ¨ï¼Œå¦‚æœæˆ‘ä»¬åˆ—è¡¨é‡Œé¢çš„å…ƒç´ æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šå˜å¤šå’Œå‡å°‘ï¼Œé‚£ä¹ˆæ²¡å…³ç³»ï¼Œåªè°ƒæ•´ã€€<code>translateY</code> å€¼å°±å¯ä»¥äº†ï¼Œä¸Šæ»‘äº†å‡ é¡µå°±å‡å‡ é¡µçš„é«˜åº¦ï¼Œä¸‹æ»‘åŒç†</p>
<p>ä½†æ˜¯å¦‚æœæ•´ä¸ªåˆ—è¡¨å‘å‰ç§»åŠ¨äº†ä¸€é¡µï¼ŒåŒæ—¶å‰é¢çš„ <code>SlideItem</code> ä¹Ÿå°‘äº†ä¸€ä¸ªï¼Œï¼Œé‚£ä¹ˆæœ€ç»ˆæ•ˆæœå°±æ˜¯ç§»åŠ¨äº†ä¸¤é¡µ...å› ä¸º <code>å¡Œé™·</code> äº†ä¸€é¡µ
è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åŒæ—¶è°ƒæ•´ <code>SlideItem</code> çš„ <code>top</code> å€¼ï¼ŒåŠ ä¸Šå‰é¢å°‘çš„ <code>SlideItem</code> çš„é«˜åº¦ï¼Œè¿™æ ·æ‰èƒ½æ˜¾ç¤ºå‡ºæ­£å¸¸çš„å†…å®¹</p>
<h1>æ­¥éª¤</h1>
<h2>å®šä¹‰</h2>
<hr>
<p><code>virtualTotal</code>ï¼šé¡µé¢ä¸­åŒæ—¶å­˜åœ¨å¤šå°‘ä¸ª <code>SlideItem</code>ï¼Œé»˜è®¤ä¸º <code>5</code>ã€‚</p>
<pre><code class="language-js">//é¡µé¢ä¸­åŒæ—¶å­˜åœ¨å¤šå°‘ä¸ªSlideItem
virtualTotal: {
  type: Number,
  default: () =&gt; 5
},
</code></pre>
<p>è®¾ç½®è¿™ä¸ªå€¼å¯ä»¥è®©å¤–éƒ¨ç»„ä»¶ä½¿ç”¨æ—¶ä¼ å…¥ï¼Œæ¯•ç«Ÿæ¯ä¸ªäººçš„éœ€æ±‚ä¸åŒï¼Œæœ‰çš„è¦æ±‚åŒæ—¶å­˜åœ¨ <code>10</code> æ¡ï¼Œæœ‰çš„è¦æ±‚åŒæ—¶å­˜åœ¨ <code>5</code> æ¡å³å¯ã€‚<br>ä¸è¿‡åŒæ—¶å­˜åœ¨çš„æ•°é‡è¶Šå¤§ï¼Œä½¿ç”¨ä½“éªŒå°±è¶Šå¥½ï¼Œå³ä½¿ç”¨æˆ·å¿«é€Ÿæ»‘åŠ¨ï¼Œæˆ‘ä»¬ä¾ç„¶æœ‰æ—¶é—´å¤„ç†ã€‚<br>å¦‚æœåªåŒæ—¶å­˜åœ¨ <code>5</code> æ¡ï¼Œç”¨æˆ·åªéœ€è¦å¿«é€Ÿæ»‘åŠ¨ä¸¤æ¬¡å°±åˆ°åº•äº†(å› ä¸ºå±å¹•ä¸­æ˜¾ç¤ºç¬¬ <code>3</code> æ¡ï¼Œåˆšå¼€å§‹é™¤å¤–)ï¼Œæˆ‘ä»¬å¯èƒ½æ¥ä¸åŠæ·»åŠ æ–°çš„è§†é¢‘åˆ°æœ€å</p>
<p><code>render</code>ï¼šæ¸²æŸ“å‡½æ•°ï¼Œ<code>SlideItem</code>å†…æ˜¾ç¤ºä»€ä¹ˆç”±<code>render</code>è¿”å›å€¼å†³å®š</p>
<pre><code class="language-js">render: {
  type: Function,
  default: () =&gt; {
    return null
  }
},
</code></pre>
<p>ä¹‹æ‰€ä»¥è¦è®¾å®šè¿™ä¸ªå€¼ï¼Œæ˜¯å› ä¸ºæŠ–éŸ³é¦–é¡µå¯ä¸åªæœ‰è§†é¢‘ï¼Œè¿˜æœ‰å›¾é›†ã€æ¨èç”¨æˆ·ã€å¹¿å‘Šç­‰å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å†™æ­»æ˜¾ç¤ºè§†é¢‘ã€‚<br>æœ€å¥½æ˜¯å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œå¤–éƒ¨å»å®ç°ï¼Œæˆ‘ä»¬å†…éƒ¨å»è°ƒç”¨ï¼Œæ‹¿åˆ°è¿”å›å€¼ï¼Œæ·»åŠ åˆ° <code>SlideList</code> ä¸­</p>
<p><code>list</code>ï¼šæ•°æ®åˆ—è¡¨ï¼Œå¤–éƒ¨ä¼ å…¥</p>
<pre><code class="language-js">list: {
  type: Array,
  default: () =&gt; {
    return []
  }
},
</code></pre>
<p>æˆ‘ä»¬ä» <code>list</code> ä¸­å–å‡ºæ•°æ®ï¼Œç„¶åè°ƒç”¨å¹¶ä¼ ç»™ <code>render</code> å‡½æ•°ï¼Œå°†å…¶è¿”å›å€¼æ’å…¥åˆ° <code>SlideListä¸­</code></p>
<h2>åˆå§‹åŒ–</h2>
<pre><code class="language-js">watch(
  () =&gt; props.list,
  (newVal, oldVal) =&gt; {
    //æ–°æ•°æ®é•¿åº¦æ¯”è€æ•°æ®é•¿åº¦å°ï¼Œè¯´æ˜æ˜¯åˆ·æ–°
    if (newVal.length &lt; oldVal.length) {
      //ä»listä¸­å–å‡ºæ•°æ®ï¼Œç„¶åè°ƒç”¨å¹¶ä¼ ç»™renderå‡½æ•°ï¼Œå°†å…¶è¿”å›å€¼æ’å…¥åˆ°SlideListä¸­
      insertContent();
    } else {
      //æ²¡æ•°æ®å°±ç›´æ¥æ’å…¥
      if (oldVal.length === 0) {
        insertContent();
      } else {
        // èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜æ˜¯é€šè¿‡æ¥å£åŠ è½½äº†ä¸‹ä¸€é¡µçš„æ•°æ®ï¼Œ
        // ä¸ºäº†åœ¨ç”¨æˆ·å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œæ— éœ€é¢‘ç¹ç­‰å¾…è¯·æ±‚æ¥å£åŠ è½½æ•°æ®ï¼Œç»™ç”¨æˆ·æ›´å¥½çš„ä½¿ç”¨ä½“éªŒ
        // è¿™é‡Œé¢å¤–åŠ è½½3æ¡æ•°æ®ã€‚æ‰€ä»¥æ­¤åˆ»ï¼Œhtmlé‡Œé¢æœ‰åŸæœ¬çš„5ä¸ªåŠ æ–°å¢çš„3ä¸ªï¼Œä¸€å…±8ä¸ªdom
        // ç”¨æˆ·å¾€ä¸‹æ»‘åŠ¨æ—¶åªåˆ é™¤å‰é¢å¤šä½™çš„domï¼Œç­‰æ»‘åŠ¨åˆ°ä¸´ç•Œå€¼ï¼ˆvirtualTotal/2+1ï¼‰æ—¶ï¼Œå†å»æ‰§è¡Œæ–°å¢é€»è¾‘
      }
    }
  }
);
</code></pre>
<p>ç”¨ <code>watch</code> ç›‘å¬ <code>list</code> æ˜¯å› ä¸ºå®ƒä¸€å¼€å§‹ä¸ä¸€å®šæœ‰å€¼ï¼Œé€šè¿‡æ¥å£è¯·æ±‚ä¹‹åæ‰æœ‰å€¼<br>åŒæ—¶å½“æˆ‘ä»¬ä¸‹æ»‘ <code>åŠ è½½æ›´å¤š</code> æ—¶ï¼Œä¹Ÿä¼šè§¦å‘æ¥å£è¯·æ±‚æ–°çš„æ•°æ®ï¼Œç”¨ <code>watch</code> å¯ä»¥åœ¨æœ‰æ–°æ•°æ®æ—¶ï¼Œå¤šæ·»åŠ å‡ æ¡åˆ° <code>SlideList</code> çš„æœ€åé¢ï¼Œè¿™æ ·ç”¨æˆ·å¿«é€Ÿæ»‘åŠ¨ä¹Ÿä¸æ€•äº†</p>
<h2>å¦‚ä½•æ»‘åŠ¨</h2>
<p>è¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œå‚è€ƒæˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š<a href="https://juejin.cn/post/7360512664317018146"><strong>200 è¡Œä»£ç å®ç°ç±»ä¼¼ Swiper.js çš„è½®æ’­ç»„ä»¶</strong></a></p>
<h2>æ»‘åŠ¨ç»“æŸ</h2>
<h3>åˆ¤æ–­æ»‘åŠ¨çš„æ–¹å‘</h3>
<p>å½“æˆ‘ä»¬å‘ä¸Šæ»‘åŠ¨æ—¶,éœ€è¦åˆ é™¤æœ€å‰é¢çš„ <code>dom</code> ï¼Œç„¶ååœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª <code>dom</code><br>ä¸‹æ»‘æ—¶åä¹‹</p>
<pre><code class="language-js">slideTouchEnd(e, state, canNext, (isNext) =&gt; {
  if (props.list.length &gt; props.virtualTotal) {
    //æ‰‹æŒ‡å¾€ä¸Šæ»‘(å³åˆ—è¡¨å±•ç¤ºä¸‹ä¸€æ¡è§†é¢‘)
    if (isNext) {
      //åˆ é™¤æœ€å‰é¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª `dom`
    } else {
      //åˆ é™¤æœ€åé¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€å‰é¢æ·»åŠ ä¸€ä¸ª `dom`
    }
  }
});
</code></pre>
<h3>æ‰‹æŒ‡å¾€ä¸Šæ»‘(å³åˆ—è¡¨å±•ç¤ºä¸‹ä¸€æ¡è§†é¢‘)</h3>
<ul>
<li>é¦–å…ˆåˆ¤æ–­æ˜¯å¦è¦åŠ è½½æ›´å¤šï¼Œå¿«åˆ°åˆ—è¡¨æœ«å°¾æ—¶å°±è¦åŠ è½½æ›´å¤šæ•°æ®äº†</li>
<li>å†åˆ¤æ–­æ˜¯å¦ç¬¦åˆ <code>è…¾æŒª</code> çš„æ¡ä»¶ï¼Œå³å½“å‰ä½ç½®è¦å¤§äº <code>half</code>ï¼Œä¸”å°äºåˆ—è¡¨é•¿åº¦å‡ <code>half</code>ã€‚</li>
<li>åœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª <code>dom</code></li>
<li>åˆ é™¤æœ€å‰é¢çš„ <code>dom</code></li>
<li>å°†æ‰€æœ‰ <code>dom</code> è®¾ç½®ä¸ºæœ€æ–°çš„ <code>top</code> å€¼(åŸå› å‰é¢æœ‰è®²ï¼Œå› ä¸ºåˆ é™¤äº†æœ€å‰é¢çš„ <code>dom</code>ï¼Œå¯¼è‡´å¡Œé™·ä¸€é¡µï¼Œæ‰€ä»¥è¦åŠ ä¸Šåˆ é™¤ <code>dom</code> çš„é«˜åº¦)</li>
</ul>
<pre><code class="language-js">let half = (props.virtualTotal - 1) / 2;

//åˆ é™¤æœ€å‰é¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª `dom`
if (
  state.localIndex &gt; props.list.length - props.virtualTotal &amp;&amp;
  state.localIndex &gt; half
) {
  emit(&quot;loadMore&quot;);
}

//æ˜¯å¦ç¬¦åˆ `è…¾æŒª` çš„æ¡ä»¶
if (state.localIndex &gt; half &amp;&amp; state.localIndex &lt; props.list.length - half) {
  //åœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª `dom`
  let addItemIndex = state.localIndex + half;
  let res = slideListEl.value.querySelector(
    `.${itemClassName}[data-index=&#39;${addItemIndex}&#39;]`
  );
  if (!res) {
    slideListEl.value.appendChild(
      getInsEl(props.list[addItemIndex], addItemIndex)
    );
  }

  //åˆ é™¤æœ€å‰é¢çš„ `dom`
  let index = slideListEl.value
    .querySelector(`.${itemClassName}:first-child`)
    .getAttribute(&quot;data-index&quot;);
  appInsMap.get(Number(index)).unmount();

  slideListEl.value.querySelectorAll(`.${itemClassName}`).forEach((item) =&gt; {
    _css(item, &quot;top&quot;, (state.localIndex - half) * state.wrapper.height);
  });
}
</code></pre>
<h3>æ‰‹æŒ‡å¾€ä¸‹æ»‘(å³åˆ—è¡¨å±•ç¤ºä¸Šä¸€æ¡è§†é¢‘)</h3>
<p>é€»è¾‘å’Œä¸Šæ»‘éƒ½å·®ä¸å¤šï¼Œä¸è¿‡æ˜¯åç€æ¥è€Œå·²</p>
<ul>
<li>å†åˆ¤æ–­æ˜¯å¦ç¬¦åˆ <code>è…¾æŒª</code> çš„æ¡ä»¶ï¼Œå’Œä¸Šé¢åç€</li>
<li>åœ¨æœ€å‰é¢æ·»åŠ ä¸€ä¸ª <code>dom</code></li>
<li>åˆ é™¤æœ€åé¢çš„ <code>dom</code></li>
<li>å°†æ‰€æœ‰ <code>dom</code> è®¾ç½®ä¸ºæœ€æ–°çš„ <code>top</code> å€¼</li>
</ul>
<pre><code class="language-js">//åˆ é™¤æœ€åé¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€å‰é¢æ·»åŠ ä¸€ä¸ª `dom`
if (
  state.localIndex &gt;= half &amp;&amp;
  state.localIndex &lt; props.list.length - (half + 1)
) {
  let addIndex = state.localIndex - half;
  if (addIndex &gt;= 0) {
    let res = slideListEl.value.querySelector(
      `.${itemClassName}[data-index=&#39;${addIndex}&#39;]`
    );
    if (!res) {
      slideListEl.value.prepend(getInsEl(props.list[addIndex], addIndex));
    }
  }
  let index = slideListEl.value
    .querySelector(`.${itemClassName}:last-child`)
    .getAttribute(&quot;data-index&quot;);
  appInsMap.get(Number(index)).unmount();

  slideListEl.value.querySelectorAll(`.${itemClassName}`).forEach((item) =&gt; {
    _css(item, &quot;top&quot;, (state.localIndex - half) * state.wrapper.height);
  });
}
</code></pre>
<h2>å…¶ä»–é—®é¢˜</h2>
<h3>ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ <code>v-for</code>ç›´æ¥ç”Ÿæˆ <code>SlideItem</code> å‘¢?</h3>
<p>å¦‚æœå†…å®¹ä¸æ˜¯è§†é¢‘å°±å¯ä»¥ã€‚è¦åˆ é™¤æˆ–è€…æ–°å¢æ—¶ï¼Œç›´æ¥æ“ä½œ <code>list</code> æ•°æ®æºï¼Œè¿™æ ·çœäº‹å¤šäº†</p>
<p>å¦‚æœå†…å®¹æ˜¯è§†é¢‘ï¼Œä¿®æ”¹ <code>list</code> æ—¶ï¼Œ<code>Vue</code> ä¼šå¿«é€Ÿçš„æ›¿æ¢ <code>dom</code>ï¼Œæ­£åœ¨æ’­æ”¾çš„è§†é¢‘ï¼Œçªç„¶ä¸€ä¸‹ä»å¤´å¼€å§‹æ’­æ”¾äº† ğŸ˜…ğŸ˜…ğŸ˜…</p>
<h3>å¦‚ä½•è·å– <code>Vue</code> ç»„ä»¶çš„æœ€ç»ˆ <code>dom</code></h3>
<p>æœ‰ä¸¤ç§æ–¹å¼ï¼Œå„æœ‰åˆ©å¼Š</p>
<ul>
<li>ç”¨ <code>Vue</code> çš„ <code>render</code> æ–¹æ³•<ul>
<li>ä¼˜ç‚¹ï¼šåªæ˜¯æ¸²æŸ“ä¸€ä¸ª <code>VNode</code> è€Œå·²ï¼Œç†è®ºä¸Šè®²å†…å­˜æ¶ˆè€—æ›´å°‘ã€‚</li>
<li>ç¼ºç‚¹ï¼šä½†æˆ‘åœ¨å¼€å‘ä¸­ï¼Œç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œä»»ä½•ä¿®æ”¹éƒ½ä¼šåˆ·æ–°é¡µé¢ï¼Œæœ‰ç‚¹éš¾èšŒ ğŸ˜…</li>
</ul>
</li>
<li>ç”¨ <code>Vue</code> çš„ <code>createApp</code> æ–¹æ³•å†åˆ›å»ºä¸€ä¸ª <code>Vue</code> çš„å®ä¾‹<ul>
<li>å’Œä¸Šé¢ç›¸å ğŸ˜…</li>
</ul>
</li>
</ul>
<pre><code class="language-js">import {
  createApp,
  onMounted,
  reactive,
  ref,
  render as vueRender,
  watch,
} from &quot;vue&quot;;

/**
 * è·å–Vueç»„ä»¶æ¸²æŸ“ä¹‹åçš„domå…ƒç´ 
 * @param item
 * @param index
 * @param play
 */
function getInsEl(item, index, play = false) {
  // console.log(&#39;index&#39;, cloneDeep(item), index, play)
  let slideVNode = props.render(item, index, play, props.uniqueId);
  const parent = document.createElement(&quot;div&quot;);
  //TODO æ‰“åŒ…åˆ°çº¿ä¸Šæ—¶ç”¨è¿™ä¸ªï¼Œè¿™ä¸ªåœ¨å¼€å‘æ—¶ä»»ä½•ä¿®æ”¹éƒ½ä¼šåˆ·æ–°é¡µé¢
  if (import.meta.env.PROD) {
    parent.classList.add(&quot;slide-item&quot;);
    parent.setAttribute(&quot;data-index&quot;, index);
    //å°†Vueç»„ä»¶æ¸²æŸ“åˆ°ä¸€ä¸ªdivä¸Š
    vueRender(slideVNode, parent);
    appInsMap.set(index, {
      unmount: () =&gt; {
        vueRender(null, parent);
        parent.remove();
      },
    });
    return parent;
  } else {
    //åˆ›å»ºä¸€ä¸ªæ–°çš„Vueå®ä¾‹ï¼Œå¹¶æŒ‚è½½åˆ°ä¸€ä¸ªdivä¸Š
    const app = createApp({
      render() {
        return &lt;SlideItem data-index={index}&gt;{slideVNode}&lt;/SlideItem&gt;;
      },
    });
    const ins = app.mount(parent);
    appInsMap.set(index, app);
    return ins.$el;
  }
}
</code></pre>
</div>
                  <div class="nav">
                    <div class="nav-prev" onclick="location.href='/250.html'">â† Prev</div>
                    <div class="nav-next" style='opacity: 0.5;pointer-events: none;'>â†’ Next</div>
                  </div>
                  <div class="home" onclick="location.href='/'">
                    <svg t="1721891362999" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6098" width="200" height="200"><path d="M249.813333 240.384a85.333333 85.333333 0 0 0-128.768 10.112L30.848 373.333333a42.666667 42.666667 0 0 0 68.736 50.56l48.554667-66.048v344.917334a128 128 0 0 0 128 128h682.666666a42.666667 42.666667 0 1 0 0-85.333334h-682.666666a42.666667 42.666667 0 0 1-42.666667-42.666666V344.192l67.498667 66.773333A42.666667 42.666667 0 0 0 360.96 350.293333L249.813333 240.384z" fill="#ffffff" p-id="6099"></path></svg>
                  </div>
                </div>
                <script src="./js/prism.min.js"></script>
                <script src="./js/script.js"></script>
              </body>
            </html>
            