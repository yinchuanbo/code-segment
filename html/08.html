<!DOCTYPE html>
            <html lang="en">
              <head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <title>Document</title>
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/default.min.css">
                <link rel="stylesheet" type="text/css" href="./css/style.css" />
              </head>
              <body>
                <div class="container">
                  <div class="container-header">
                    <h2>js 接口限制并发</h2>
                    <p>2024-06-03 22:04:08 · YinHao</p>
                  </div>
                  <ul>
<li>当有大量请求需要发起时，往往需求限制并发数量保证其他请求能优先返回。</li>
</ul>
<pre><code class="language-js">async function asyncPool(poolLimit, iterable, iteratorFn) {
  // 用于保存所有异步请求
  const ret = [];
  // 用户保存正在进行的请求
  const executing = new Set();
  for (const item of iterable) {
    // 构造出请求 Promise
    const p = Promise.resolve().then(() =&gt; iteratorFn(item, iterable));
    ret.push(p);
    executing.add(p);
    // 请求执行结束后从正在进行的数组中移除
    const clean = () =&gt; executing.delete(p);
    p.then(clean).catch(clean);
    // 如果正在执行的请求数大于并发数，就使用 Promise.race 等待一个最快执行完的请求
    if (executing.size &gt;= poolLimit) {
      await Promise.race(executing);
    }
  }
  // 返回所有结果
  return Promise.all(ret);
}

// 使用方法
const timeout = (i) =&gt;
  new Promise((resolve) =&gt; setTimeout(() =&gt; resolve(i), i));
asyncPool(2, [1000, 5000, 3000, 2000], timeout).then((results) =&gt; {
  console.log(results);
});
</code></pre>

                  <div class="nav">
                    <div class="nav-prev" onclick="location.href='/07.html'">PREV</div>
                    <div class="nav-next" onclick="location.href='/09.html'">NEXT</div>
                  </div>
                </div>
              <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
              <script>hljs.highlightAll();</script>
              </body>
            </html>
            