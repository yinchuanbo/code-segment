<!DOCTYPE html>
            <html lang="en">
              <head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <title>使用 volta 统一了前端各项目的 node 版本</title>
                <link rel=icon href="./imgs/code.svg" sizes=32x32>
                <link rel="stylesheet" href="./css/prism.css">
                <link rel="stylesheet" type="text/css" href="./css/style.css" />
              </head>
              <body>
                <div class="container">
                  <div class="container-header">
                    <h2>使用 volta 统一了前端各项目的 node 版本</h2>
                    <p>2024-06-26 19:53:21 · YinHao</p>
                  </div>
                  <p>公司项目存在三个版本的 node：20、16、12，平时项目开发都是通过<code>n/nvm</code>来回切换，比较低效</p>
<h3>优点</h3>
<ol>
<li>方便项目级别管理 node 版本，只要在 package.json 增加 volta-node 版本，自动切换到对应的版本</li>
<li>相比于 vscode 插件，volta 可以在命令行运行，比如 teminal</li>
<li>公司设备都是 mac，volta 可以直接命令行安装（windows 官网也可以用，还没测试）</li>
<li>切换速度比较好，体验较好（rust 编写）</li>
</ol>
<h3>公司项目整合效果</h3>
<p>各项目同打上了 volta-node 标识，node 版本跟 jenkins 打包的版本保持统一。可以不同版本项目同时跑起来了，再也不用来回切 node 版本了。跑了一段时间后很丝滑，再也不用来回切换 node 版本了。</p>
<h3>下面列出使用的文档以及踩的坑</h3>
<h3>volta 官网</h3>
<p><a href="https://docs.volta.sh/guide/#how-does-it-work">docs.volta.sh/guide/#how-…</a></p>
<h3>mac 安装方式</h3>
<pre><code class="language-bash"># install Volta
curl https://get.volta.sh | bash
source ~/.bash_profile
</code></pre>
<p>安装好，vscode 还是旧的版本，需要重启 vscode 生效</p>
<h3>Mac  上  Node  的安装地址：</h3>
<p>当你使用  Volta  来安装  Node.js  时，Node.js  不是安装在  Mac  上的传统位置（例如  <code>/usr/local/bin</code>  或  <code>/opt</code>），而是安装在  Volta  的沙盒内。具体到文件系统路径，则大致如下：</p>
<ul>
<li>Volta  安装目录：<code>~/.volta</code>（在用户的主目录下）</li>
<li>Node  版本安装目录：<code>~/.volta/tools/image/node</code>（这里会包含不同版本的  Node.js  实例）</li>
</ul>
<h3>常见命令及踩坑</h3>
<ul>
<li>pin:  不同项目 node 版本不同</li>
</ul>
<pre><code class="language-shell">volta pin node@12
volta pin yarn@1.22.2
</code></pre>
<p>pin 后，packag.json 会产生 volta 标识（后续 volta 将会软链到对应的 node 包）</p>
<pre><code class="language-json">// package.json
{
 &quot;volta&quot;: {
 &quot;node&quot;: &quot;16.15.0&quot;,
 &quot;yarn&quot;: &quot;1.22.21&quot;
 }
}
</code></pre>
<ul>
<li>install:  全局安装 node(将会覆盖 n 等安装的 node 版本)</li>
</ul>
<pre><code class="language-sh">volta install node@12
</code></pre>
<h3>常见疑问</h3>
<ol>
<li>安装可能遇到问题</li>
</ol>
<p>github 的 volta 的 release 无法下载下来，可以给 github 加上代理（这个加速也适合 git clone 加速拉取项目）</p>
<pre><code class="language-ruby">可能问题：
curl: (22) The requested URL returned error: 404
Error: Could not download Volta version &#39;&#39;. See https://github.com/volta-cli/volta/releases for a list of available releases
解决：
github 加上代理
将 volta.sh 下载到本地
curl -k https://get.volta.sh &gt; volta.sh
修改 github 源

# echo &quot;https://mirror.ghproxy.com/https://github.com/volta-cli/volta/releases&quot;

chmod +x volta.sh
运行
./volta.sh
</code></pre>
<ol start="2">
<li>卸载 volta 全局安装的 node 包</li>
</ol>
<p><a href="https://github.com/volta-cli/volta/issues/327">uninstall issue</a></p>
<p>当前全局安装的 node 包，通过 uninstall 无法卸载。需要手动解决</p>
<p>javascript</p>
<p>复制代码</p>
<p><code>removed the node version from `~/.volta/tools/user/platform.json` </code></p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0dd97baddf0844b0b08726f816c9eb1f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=774&h=620&s=119903&e=png&b=f3f4f4" alt="image.png"> 3. 跟 n，nvm 全局管理工具不冲突</p>
<p>可以项目采用 volta 管理 node，全局采用其他，当然直接采用 volta 管理全局 node 也可以</p>
<h3>pnpm 支持</h3>
<p>之前如果全局安装 pnpm，比如通过 npm，<code>npm i pnpm -g</code> ，pnpm 在 mac 的安装地址为：<code>/usr/local/bin/pnpm</code>，注意不是全局 pnpm 的 node_modules 缓存地址（可通过 pnpm store path 查看）</p>
<p>虽然我们配置了 volta，项目中也 pin 了 node 版本，但是通过 pnpm 在项目中去获取 node 版本，发现跟 yarn 不一致。</p>
<p>pnpm 还是获取的全局的 node 版本，而不是项目中 pin 的 node 版本。</p>
<p><strong>测试例子</strong></p>
<p>比如：全局 node 的版本是 20.11.0，package.json pin 后的 node 版本是 16.15.0</p>
<p>shell</p>
<p>复制代码</p>
<p><code># package.json &quot;volta&quot;: {  &quot;node&quot;: &quot;16.15.0&quot;,  &quot;yarn&quot;: &quot;1.22.21&quot; }</code></p>
<p>项目中命令行检验 node 版本，命令如下</p>
<p>shell</p>
<p>复制代码</p>
<p>`# 因为 pin 了 yarn，此时 volta 软链查到 node 版本：16.15.0
yarn node -v</p>
<h1>pnpm 还没有设置好，此时还是全局的 node 版本：20.11.0</h1>
<h1>pnpm node -v`</h1>
<p><strong>pnpm 在 volta 中设置方法</strong></p>
<p>pnpm 配置指南[<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdocs.volta.sh%2Fadvanced%2Fpnpm" title="https://docs.volta.sh/advanced/pnpm">docs.volta.sh/advanced/pn…</a>]</p>
<p>pnpm 的支持还是实验性质的，可能会有 bug，目前试下来不影响正常使用 <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1eb220018b664e8d91303f7a2947d21e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1158&h=289&s=68635&e=png&b=ffffff" alt="image.png"></p>
<ol>
<li>增加全局变量<code>VOLTA_FEATURE_PNPM=1</code></li>
</ol>
<p>shell</p>
<p>复制代码</p>
<p>`vim ~/.bash_profile</p>
<h1>添加一行 VOLTA_FEATURE_PNPM 变量</h1>
<h1>export VOLTA_FEATURE_PNPM=1</h1>
<p>source ~/.bash_profile`</p>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc4277b5eadc4eab877a6927a7948206~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1104&h=140&s=58704&e=png&b=fefefe" alt="image.png"></p>
<ol start="2">
<li>pin pnpm 到项目中 <code>volta pin pnpm</code></li>
</ol>
<p>shell</p>
<p>复制代码</p>
<p><code>#  package.json  &quot;volta&quot;: {  &quot;node&quot;: &quot;16.15.0&quot;,  &quot;yarn&quot;: &quot;1.22.21&quot;,  &quot;pnpm&quot;: &quot;8.15.6&quot;  }</code></p>
<ol start="3">
<li>重启 vscode 再次测试<code>pnpm node -v</code> 展示 16.15.0 则说明 pnpm 配置成功</li>
</ol>
<p>** 可能的错误：**</p>
<ol>
<li>重启 vscode，再次 pin pnpm</li>
</ol>
<p>go</p>
<p>复制代码</p>
<p><code>error: Only node and yarn can be pinned in a project Use `npm install` or `yarn add` to select a version of pnpm for this project. sh-3.2$</code></p>
<h3>volta 基本原理</h3>
<p>安装 volta 后，node 或者其他包管理器：npm、yarn 等全局安装二进制文件被重定向到  <code>.volta/bin</code>  目录下，而这些脚本又软链到了<code>volta-shim</code></p>
<p>通过<code>which</code>脚本能看到二进制被修改到 volta ，<code>which node</code> ，<code>which yarn</code>等，没安装前都在<code>/usr/local/bin/xxx</code>，</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e0cd84d0e974462bdd8ee170f03e092~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=810&h=230&s=92892&e=png&b=fefefe" alt="image.png"></p>
<p><strong>查看 volta bin</strong></p>
<p>打开 volta bin 目录<code>cd ~/.volta/bin</code> <img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c4ef0f0902342a3a084033fdcd54496~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1380&h=520&s=108044&e=png&b=fefefe" alt="image.png"> <code>ls -l</code>查看列表文件信息，node npm 等都软链到了 volta-shim <img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0445936e9e7b4cd9ab90fd0620df3c92~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1400&h=288&s=177871&e=png&b=fefefe" alt="image.png"></p>
<p><strong>volta-shim 的主要作用</strong></p>
<p>shim 充当了一个智能路由器的角色，在运行命令时将你的请求路由到正确的 node 或者包管理器版本。</p>
<p>当你执行 node -v 或者 npm，yarn 等时，volta-shim,它会从项目的  <code>package.json</code>  的  <code>volta</code>  字段读取 node 以及包管理器版本（npm yarn 等）版本信息。如果没有配置 volta，它会使用用户全局默认的版本。</p>
<p>对于 node 来说，默认 volta 就会使用之前安装的 node 版本。当然也可以通过 volta 去接管全局的 node，<code>volta install node@xx</code>的方式，用 volta 来接管全局的 node 版本。</p>
<h3>最后</h3>
<p><a href="https://juejin.cn/post/7342787949250232354">https://juejin.cn/post/7342787949250232354</a></p>

                  <div class="nav">
                    <div class="nav-prev" onclick="location.href='/163.html'"><svg t="1718969043615" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1666" width="30" height="30"><path d="M896 309.12v405.76c0 98.986667-107.562667 160.512-192.896 110.336l-344.874667-202.88c-84.138667-49.493333-84.138667-171.178667 0-220.672l344.874667-202.88c85.333333-50.176 192.896 11.349333 192.896 110.336z m-64 0a64 64 0 0 0-91.477333-57.813333l-4.992 2.645333-344.874667 202.88a64 64 0 0 0-5.248 106.922667l5.248 3.413333 344.874667 202.88a64 64 0 0 0 96.213333-49.536l0.256-5.632v-405.76zM138.666667 213.333333v597.333334a32 32 0 0 0 64 0V213.333333a32 32 0 1 0-64 0z" fill="#ffffff" p-id="1667"></path></svg></div>
                    <div class="nav-next" style='opacity: 0.5;pointer-events: none;'><svg t="1718969061843" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2029" id="mx_n_1718969061843" width="30" height="30"><path d="M128 309.12c0-96.554667 102.4-157.482667 186.624-113.792l6.272 3.456 344.874667 202.88c81.664 48.042667 84.053333 164.096 7.210666 216.106667l-7.210666 4.565333-344.874667 202.88c-83.242667 48.938667-187.648-8.405333-192.725333-103.168L128 714.88v-405.76z m64 0v405.76a64 64 0 0 0 96.426667 55.168l344.917333-202.88a64 64 0 0 0 0-110.336L288.426667 253.952A64 64 0 0 0 192 309.12zM885.333333 213.333333v597.333334a32 32 0 0 1-64 0V213.333333a32 32 0 1 1 64 0z" fill="#ffffff" p-id="2030"></path></svg></div>
                  </div>
                  <div class="home" onclick="location.href='/'"><svg t="1718968866110" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6450" width="30" height="30"><path d="M922.24 531.2c-8.32 0-16.64-3.2-22.4-9.6L568.32 190.08c-26.24-26.24-69.12-26.24-95.36 0L142.08 521.6c-12.8 12.8-32.64 12.8-45.44 0s-12.8-32.64 0-45.44l331.52-331.52c51.2-51.2 134.4-51.2 186.24 0l331.52 331.52c12.8 12.8 12.8 32.64 0 45.44-7.04 6.4-15.36 9.6-23.68 9.6z" fill="#ffffff" p-id="6451"></path><path d="M723.84 938.88H310.4c-80 0-144.64-65.28-144.64-144.64V426.24c0-17.92 14.08-32 32-32s32 14.08 32 32v368c0 44.8 36.48 80.64 80.64 80.64h413.44c44.8 0 80.64-36.48 80.64-80.64V586.24c0-17.92 14.08-32 32-32s32 14.08 32 32v208c0 80-64.64 144.64-144.64 144.64z" fill="#ffffff" p-id="6452"></path></svg></div>
                </div>
                <script src="./js/prism.min.js"></script>
                <script src="./js/script.js"></script>
              </body>
            </html>
            