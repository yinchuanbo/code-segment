---
date: 2024-06-26T19:53:21+08:00
title: "使用 volta 统一了前端各项目的 node 版本"
---

公司项目存在三个版本的 node：20、16、12，平时项目开发都是通过`n/nvm`来回切换，比较低效

### 优点

1. 方便项目级别管理 node 版本，只要在 package.json 增加 volta-node 版本，自动切换到对应的版本
2. 相比于 vscode 插件，volta 可以在命令行运行，比如 teminal
3. 公司设备都是 mac，volta 可以直接命令行安装（windows 官网也可以用，还没测试）
4. 切换速度比较好，体验较好（rust 编写）

### 公司项目整合效果

各项目同打上了 volta-node 标识，node 版本跟 jenkins 打包的版本保持统一。可以不同版本项目同时跑起来了，再也不用来回切 node 版本了。跑了一段时间后很丝滑，再也不用来回切换 node 版本了。

### 下面列出使用的文档以及踩的坑

### volta 官网

[docs.volta.sh/guide/#how-…](https://docs.volta.sh/guide/#how-does-it-work)

### mac 安装方式

```bash
# install Volta
curl https://get.volta.sh | bash
source ~/.bash_profile
```

安装好，vscode 还是旧的版本，需要重启 vscode 生效

### Mac  上  Node  的安装地址：

当你使用  Volta  来安装  Node.js  时，Node.js  不是安装在  Mac  上的传统位置（例如  `/usr/local/bin`  或  `/opt`），而是安装在  Volta  的沙盒内。具体到文件系统路径，则大致如下：

- Volta  安装目录：`~/.volta`（在用户的主目录下）
- Node  版本安装目录：`~/.volta/tools/image/node`（这里会包含不同版本的  Node.js  实例）

### 常见命令及踩坑

- pin:  不同项目 node 版本不同

```shell
volta pin node@12
volta pin yarn@1.22.2
```

pin 后，packag.json 会产生 volta 标识（后续 volta 将会软链到对应的 node 包）

```json
// package.json
{
 "volta": {
 "node": "16.15.0",
 "yarn": "1.22.21"
 }
}
```

- install:  全局安装 node(将会覆盖 n 等安装的 node 版本)

```sh
volta install node@12
```

### 常见疑问

1. 安装可能遇到问题

github 的 volta 的 release 无法下载下来，可以给 github 加上代理（这个加速也适合 git clone 加速拉取项目）

```ruby
可能问题：
curl: (22) The requested URL returned error: 404
Error: Could not download Volta version ''. See https://github.com/volta-cli/volta/releases for a list of available releases
解决：
github 加上代理
将 volta.sh 下载到本地
curl -k https://get.volta.sh > volta.sh
修改 github 源

# echo "https://mirror.ghproxy.com/https://github.com/volta-cli/volta/releases"

chmod +x volta.sh
运行
./volta.sh
```

2. 卸载 volta 全局安装的 node 包

[uninstall issue](https://github.com/volta-cli/volta/issues/327)

当前全局安装的 node 包，通过 uninstall 无法卸载。需要手动解决

javascript

复制代码

`` removed the node version from `~/.volta/tools/user/platform.json`  ``

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0dd97baddf0844b0b08726f816c9eb1f~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=774&h=620&s=119903&e=png&b=f3f4f4) 3. 跟 n，nvm 全局管理工具不冲突

可以项目采用 volta 管理 node，全局采用其他，当然直接采用 volta 管理全局 node 也可以

### pnpm 支持

之前如果全局安装 pnpm，比如通过 npm，`npm i pnpm -g` ，pnpm 在 mac 的安装地址为：`/usr/local/bin/pnpm`，注意不是全局 pnpm 的 node_modules 缓存地址（可通过 pnpm store path 查看）

虽然我们配置了 volta，项目中也 pin 了 node 版本，但是通过 pnpm 在项目中去获取 node 版本，发现跟 yarn 不一致。

pnpm 还是获取的全局的 node 版本，而不是项目中 pin 的 node 版本。

**测试例子**

比如：全局 node 的版本是 20.11.0，package.json pin 后的 node 版本是 16.15.0

shell

复制代码

`# package.json
"volta": {
 "node": "16.15.0",
 "yarn": "1.22.21"
}`

项目中命令行检验 node 版本，命令如下

shell

复制代码

`# 因为 pin 了 yarn，此时 volta 软链查到 node 版本：16.15.0
yarn node -v

# pnpm 还没有设置好，此时还是全局的 node 版本：20.11.0

# pnpm node -v`

**pnpm 在 volta 中设置方法**

pnpm 配置指南\[[docs.volta.sh/advanced/pn…](https://link.juejin.cn/?target=https%3A%2F%2Fdocs.volta.sh%2Fadvanced%2Fpnpm "https://docs.volta.sh/advanced/pnpm")\]

pnpm 的支持还是实验性质的，可能会有 bug，目前试下来不影响正常使用 ![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1eb220018b664e8d91303f7a2947d21e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1158&h=289&s=68635&e=png&b=ffffff)

1. 增加全局变量`VOLTA_FEATURE_PNPM=1`

shell

复制代码

`vim ~/.bash_profile

# 添加一行 VOLTA_FEATURE_PNPM 变量

# export VOLTA_FEATURE_PNPM=1

source ~/.bash_profile`

![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bc4277b5eadc4eab877a6927a7948206~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1104&h=140&s=58704&e=png&b=fefefe)

2. pin pnpm 到项目中 `volta pin pnpm`

shell

复制代码

`#  package.json
 "volta": {
 "node": "16.15.0",
 "yarn": "1.22.21",
 "pnpm": "8.15.6"
 }`

3. 重启 vscode 再次测试`pnpm node -v` 展示 16.15.0 则说明 pnpm 配置成功

\*\* 可能的错误：\*\*

1. 重启 vscode，再次 pin pnpm

go

复制代码

`` error: Only node and yarn can be pinned in a project
Use `npm install` or `yarn add` to select a version of pnpm for this project.
sh-3.2$ ``

### volta 基本原理

安装 volta 后，node 或者其他包管理器：npm、yarn 等全局安装二进制文件被重定向到  `.volta/bin`  目录下，而这些脚本又软链到了`volta-shim`

通过`which`脚本能看到二进制被修改到 volta ，`which node` ，`which yarn`等，没安装前都在`/usr/local/bin/xxx`，

![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4e0cd84d0e974462bdd8ee170f03e092~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=810&h=230&s=92892&e=png&b=fefefe)

**查看 volta bin**

打开 volta bin 目录`cd ~/.volta/bin` ![image.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4c4ef0f0902342a3a084033fdcd54496~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1380&h=520&s=108044&e=png&b=fefefe) `ls -l`查看列表文件信息，node npm 等都软链到了 volta-shim ![image.png](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0445936e9e7b4cd9ab90fd0620df3c92~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1400&h=288&s=177871&e=png&b=fefefe)

**volta-shim 的主要作用**

shim 充当了一个智能路由器的角色，在运行命令时将你的请求路由到正确的 node 或者包管理器版本。

当你执行 node -v 或者 npm，yarn 等时，volta-shim,它会从项目的  `package.json`  的  `volta`  字段读取 node 以及包管理器版本（npm yarn 等）版本信息。如果没有配置 volta，它会使用用户全局默认的版本。

对于 node 来说，默认 volta 就会使用之前安装的 node 版本。当然也可以通过 volta 去接管全局的 node，`volta install node@xx`的方式，用 volta 来接管全局的 node 版本。

### 最后

https://juejin.cn/post/7342787949250232354