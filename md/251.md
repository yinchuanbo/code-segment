---
date: 2024-07-25T16:35:17+08:00
title: "å®ç°æŠ–éŸ³ â€œè§†é¢‘æ— é™æ»‘åŠ¨â€œæ•ˆæœ"
---

# æœ€ç»ˆæ•ˆæœ

åœ¨çº¿é¢„è§ˆï¼š[dy.ttentau.top/](https://dy.ttentau.top/)

Github åœ°å€ï¼š[github.com/zyronon/douâ€¦](https://github.com/zyronon/douyin)

æºç ï¼š[SlideVerticalInfinite.vue](https://github.com/zyronon/douyin/blob/master/src/components/slide/SlideVerticalInfinite.vue)

# å®ç°åŸç†

æ— é™æ»‘åŠ¨çš„åŸç†å’Œè™šæ‹Ÿæ»šåŠ¨çš„åŸç†å·®ä¸å¤šï¼Œè¦ä¿æŒ `SlideList` é‡Œé¢æ°¸è¿œåªæœ‰ `N` ä¸ª `SlideItem`ï¼Œå°±è¦åœ¨æ»‘åŠ¨æ—¶ä¸æ–­çš„åˆ é™¤å’Œå¢åŠ  `SlideItem`ã€‚
æ»‘åŠ¨æ—¶è°ƒæ•´ `SlideList` çš„åç§»é‡ `translateY` çš„å€¼ï¼Œä»¥åŠåˆ—è¡¨é‡Œé‚£å‡ ä¸ª `SlideItem` çš„ `top` å€¼ï¼Œå°±å¯ä»¥äº†

ä¸ºä»€ä¹ˆè¦è°ƒæ•´ `SlideList` çš„åç§»é‡ `translateY` çš„å€¼åŒæ—¶è¿˜è¦è°ƒæ•´ `SlideItem` çš„ `top` å€¼å‘¢ï¼Ÿ
å› ä¸º `translateY` åªæ˜¯å°†æ•´ä¸ªåˆ—è¡¨ç§»åŠ¨ï¼Œå¦‚æœæˆ‘ä»¬åˆ—è¡¨é‡Œé¢çš„å…ƒç´ æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šå˜å¤šå’Œå‡å°‘ï¼Œé‚£ä¹ˆæ²¡å…³ç³»ï¼Œåªè°ƒæ•´ã€€`translateY` å€¼å°±å¯ä»¥äº†ï¼Œä¸Šæ»‘äº†å‡ é¡µå°±å‡å‡ é¡µçš„é«˜åº¦ï¼Œä¸‹æ»‘åŒç†

ä½†æ˜¯å¦‚æœæ•´ä¸ªåˆ—è¡¨å‘å‰ç§»åŠ¨äº†ä¸€é¡µï¼ŒåŒæ—¶å‰é¢çš„ `SlideItem` ä¹Ÿå°‘äº†ä¸€ä¸ªï¼Œï¼Œé‚£ä¹ˆæœ€ç»ˆæ•ˆæœå°±æ˜¯ç§»åŠ¨äº†ä¸¤é¡µ...å› ä¸º `å¡Œé™·` äº†ä¸€é¡µ
è¿™æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦åŒæ—¶è°ƒæ•´ `SlideItem` çš„ `top` å€¼ï¼ŒåŠ ä¸Šå‰é¢å°‘çš„ `SlideItem` çš„é«˜åº¦ï¼Œè¿™æ ·æ‰èƒ½æ˜¾ç¤ºå‡ºæ­£å¸¸çš„å†…å®¹

# æ­¥éª¤

## å®šä¹‰

---

`virtualTotal`ï¼šé¡µé¢ä¸­åŒæ—¶å­˜åœ¨å¤šå°‘ä¸ª `SlideItem`ï¼Œé»˜è®¤ä¸º `5`ã€‚

```js
//é¡µé¢ä¸­åŒæ—¶å­˜åœ¨å¤šå°‘ä¸ªSlideItem
virtualTotal: {
  type: Number,
  default: () => 5
},

```

è®¾ç½®è¿™ä¸ªå€¼å¯ä»¥è®©å¤–éƒ¨ç»„ä»¶ä½¿ç”¨æ—¶ä¼ å…¥ï¼Œæ¯•ç«Ÿæ¯ä¸ªäººçš„éœ€æ±‚ä¸åŒï¼Œæœ‰çš„è¦æ±‚åŒæ—¶å­˜åœ¨ `10` æ¡ï¼Œæœ‰çš„è¦æ±‚åŒæ—¶å­˜åœ¨ `5` æ¡å³å¯ã€‚  
ä¸è¿‡åŒæ—¶å­˜åœ¨çš„æ•°é‡è¶Šå¤§ï¼Œä½¿ç”¨ä½“éªŒå°±è¶Šå¥½ï¼Œå³ä½¿ç”¨æˆ·å¿«é€Ÿæ»‘åŠ¨ï¼Œæˆ‘ä»¬ä¾ç„¶æœ‰æ—¶é—´å¤„ç†ã€‚  
å¦‚æœåªåŒæ—¶å­˜åœ¨ `5` æ¡ï¼Œç”¨æˆ·åªéœ€è¦å¿«é€Ÿæ»‘åŠ¨ä¸¤æ¬¡å°±åˆ°åº•äº†(å› ä¸ºå±å¹•ä¸­æ˜¾ç¤ºç¬¬ `3` æ¡ï¼Œåˆšå¼€å§‹é™¤å¤–)ï¼Œæˆ‘ä»¬å¯èƒ½æ¥ä¸åŠæ·»åŠ æ–°çš„è§†é¢‘åˆ°æœ€å

`render`ï¼šæ¸²æŸ“å‡½æ•°ï¼Œ`SlideItem`å†…æ˜¾ç¤ºä»€ä¹ˆç”±`render`è¿”å›å€¼å†³å®š

```js
render: {
  type: Function,
  default: () => {
    return null
  }
},
```

ä¹‹æ‰€ä»¥è¦è®¾å®šè¿™ä¸ªå€¼ï¼Œæ˜¯å› ä¸ºæŠ–éŸ³é¦–é¡µå¯ä¸åªæœ‰è§†é¢‘ï¼Œè¿˜æœ‰å›¾é›†ã€æ¨èç”¨æˆ·ã€å¹¿å‘Šç­‰å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å†™æ­»æ˜¾ç¤ºè§†é¢‘ã€‚  
æœ€å¥½æ˜¯å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œå¤–éƒ¨å»å®ç°ï¼Œæˆ‘ä»¬å†…éƒ¨å»è°ƒç”¨ï¼Œæ‹¿åˆ°è¿”å›å€¼ï¼Œæ·»åŠ åˆ° `SlideList` ä¸­

`list`ï¼šæ•°æ®åˆ—è¡¨ï¼Œå¤–éƒ¨ä¼ å…¥

```js
list: {
  type: Array,
  default: () => {
    return []
  }
},
```

æˆ‘ä»¬ä» `list` ä¸­å–å‡ºæ•°æ®ï¼Œç„¶åè°ƒç”¨å¹¶ä¼ ç»™ `render` å‡½æ•°ï¼Œå°†å…¶è¿”å›å€¼æ’å…¥åˆ° `SlideListä¸­`

## åˆå§‹åŒ–

```js
watch(
  () => props.list,
  (newVal, oldVal) => {
    //æ–°æ•°æ®é•¿åº¦æ¯”è€æ•°æ®é•¿åº¦å°ï¼Œè¯´æ˜æ˜¯åˆ·æ–°
    if (newVal.length < oldVal.length) {
      //ä»listä¸­å–å‡ºæ•°æ®ï¼Œç„¶åè°ƒç”¨å¹¶ä¼ ç»™renderå‡½æ•°ï¼Œå°†å…¶è¿”å›å€¼æ’å…¥åˆ°SlideListä¸­
      insertContent();
    } else {
      //æ²¡æ•°æ®å°±ç›´æ¥æ’å…¥
      if (oldVal.length === 0) {
        insertContent();
      } else {
        // èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜æ˜¯é€šè¿‡æ¥å£åŠ è½½äº†ä¸‹ä¸€é¡µçš„æ•°æ®ï¼Œ
        // ä¸ºäº†åœ¨ç”¨æˆ·å¿«é€Ÿæ»‘åŠ¨æ—¶ï¼Œæ— éœ€é¢‘ç¹ç­‰å¾…è¯·æ±‚æ¥å£åŠ è½½æ•°æ®ï¼Œç»™ç”¨æˆ·æ›´å¥½çš„ä½¿ç”¨ä½“éªŒ
        // è¿™é‡Œé¢å¤–åŠ è½½3æ¡æ•°æ®ã€‚æ‰€ä»¥æ­¤åˆ»ï¼Œhtmlé‡Œé¢æœ‰åŸæœ¬çš„5ä¸ªåŠ æ–°å¢çš„3ä¸ªï¼Œä¸€å…±8ä¸ªdom
        // ç”¨æˆ·å¾€ä¸‹æ»‘åŠ¨æ—¶åªåˆ é™¤å‰é¢å¤šä½™çš„domï¼Œç­‰æ»‘åŠ¨åˆ°ä¸´ç•Œå€¼ï¼ˆvirtualTotal/2+1ï¼‰æ—¶ï¼Œå†å»æ‰§è¡Œæ–°å¢é€»è¾‘
      }
    }
  }
);
```

ç”¨ `watch` ç›‘å¬ `list` æ˜¯å› ä¸ºå®ƒä¸€å¼€å§‹ä¸ä¸€å®šæœ‰å€¼ï¼Œé€šè¿‡æ¥å£è¯·æ±‚ä¹‹åæ‰æœ‰å€¼  
åŒæ—¶å½“æˆ‘ä»¬ä¸‹æ»‘ `åŠ è½½æ›´å¤š` æ—¶ï¼Œä¹Ÿä¼šè§¦å‘æ¥å£è¯·æ±‚æ–°çš„æ•°æ®ï¼Œç”¨ `watch` å¯ä»¥åœ¨æœ‰æ–°æ•°æ®æ—¶ï¼Œå¤šæ·»åŠ å‡ æ¡åˆ° `SlideList` çš„æœ€åé¢ï¼Œè¿™æ ·ç”¨æˆ·å¿«é€Ÿæ»‘åŠ¨ä¹Ÿä¸æ€•äº†

## å¦‚ä½•æ»‘åŠ¨

è¿™é‡Œå°±ä¸å†èµ˜è¿°ï¼Œå‚è€ƒæˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š[**200 è¡Œä»£ç å®ç°ç±»ä¼¼ Swiper.js çš„è½®æ’­ç»„ä»¶**](https://juejin.cn/post/7360512664317018146)

## æ»‘åŠ¨ç»“æŸ

### åˆ¤æ–­æ»‘åŠ¨çš„æ–¹å‘

å½“æˆ‘ä»¬å‘ä¸Šæ»‘åŠ¨æ—¶,éœ€è¦åˆ é™¤æœ€å‰é¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª `dom`  
ä¸‹æ»‘æ—¶åä¹‹

```js
slideTouchEnd(e, state, canNext, (isNext) => {
  if (props.list.length > props.virtualTotal) {
    //æ‰‹æŒ‡å¾€ä¸Šæ»‘(å³åˆ—è¡¨å±•ç¤ºä¸‹ä¸€æ¡è§†é¢‘)
    if (isNext) {
      //åˆ é™¤æœ€å‰é¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª `dom`
    } else {
      //åˆ é™¤æœ€åé¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€å‰é¢æ·»åŠ ä¸€ä¸ª `dom`
    }
  }
});
```

### æ‰‹æŒ‡å¾€ä¸Šæ»‘(å³åˆ—è¡¨å±•ç¤ºä¸‹ä¸€æ¡è§†é¢‘)

- é¦–å…ˆåˆ¤æ–­æ˜¯å¦è¦åŠ è½½æ›´å¤šï¼Œå¿«åˆ°åˆ—è¡¨æœ«å°¾æ—¶å°±è¦åŠ è½½æ›´å¤šæ•°æ®äº†
- å†åˆ¤æ–­æ˜¯å¦ç¬¦åˆ `è…¾æŒª` çš„æ¡ä»¶ï¼Œå³å½“å‰ä½ç½®è¦å¤§äº `half`ï¼Œä¸”å°äºåˆ—è¡¨é•¿åº¦å‡ `half`ã€‚
- åœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª `dom`
- åˆ é™¤æœ€å‰é¢çš„ `dom`
- å°†æ‰€æœ‰ `dom` è®¾ç½®ä¸ºæœ€æ–°çš„ `top` å€¼(åŸå› å‰é¢æœ‰è®²ï¼Œå› ä¸ºåˆ é™¤äº†æœ€å‰é¢çš„ `dom`ï¼Œå¯¼è‡´å¡Œé™·ä¸€é¡µï¼Œæ‰€ä»¥è¦åŠ ä¸Šåˆ é™¤ `dom` çš„é«˜åº¦)

```js
let half = (props.virtualTotal - 1) / 2;

//åˆ é™¤æœ€å‰é¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª `dom`
if (
  state.localIndex > props.list.length - props.virtualTotal &&
  state.localIndex > half
) {
  emit("loadMore");
}

//æ˜¯å¦ç¬¦åˆ `è…¾æŒª` çš„æ¡ä»¶
if (state.localIndex > half && state.localIndex < props.list.length - half) {
  //åœ¨æœ€åé¢æ·»åŠ ä¸€ä¸ª `dom`
  let addItemIndex = state.localIndex + half;
  let res = slideListEl.value.querySelector(
    `.${itemClassName}[data-index='${addItemIndex}']`
  );
  if (!res) {
    slideListEl.value.appendChild(
      getInsEl(props.list[addItemIndex], addItemIndex)
    );
  }

  //åˆ é™¤æœ€å‰é¢çš„ `dom`
  let index = slideListEl.value
    .querySelector(`.${itemClassName}:first-child`)
    .getAttribute("data-index");
  appInsMap.get(Number(index)).unmount();

  slideListEl.value.querySelectorAll(`.${itemClassName}`).forEach((item) => {
    _css(item, "top", (state.localIndex - half) * state.wrapper.height);
  });
}
```

### æ‰‹æŒ‡å¾€ä¸‹æ»‘(å³åˆ—è¡¨å±•ç¤ºä¸Šä¸€æ¡è§†é¢‘)

é€»è¾‘å’Œä¸Šæ»‘éƒ½å·®ä¸å¤šï¼Œä¸è¿‡æ˜¯åç€æ¥è€Œå·²

- å†åˆ¤æ–­æ˜¯å¦ç¬¦åˆ `è…¾æŒª` çš„æ¡ä»¶ï¼Œå’Œä¸Šé¢åç€
- åœ¨æœ€å‰é¢æ·»åŠ ä¸€ä¸ª `dom`
- åˆ é™¤æœ€åé¢çš„ `dom`
- å°†æ‰€æœ‰ `dom` è®¾ç½®ä¸ºæœ€æ–°çš„ `top` å€¼

```js
//åˆ é™¤æœ€åé¢çš„ `dom` ï¼Œç„¶ååœ¨æœ€å‰é¢æ·»åŠ ä¸€ä¸ª `dom`
if (
  state.localIndex >= half &&
  state.localIndex < props.list.length - (half + 1)
) {
  let addIndex = state.localIndex - half;
  if (addIndex >= 0) {
    let res = slideListEl.value.querySelector(
      `.${itemClassName}[data-index='${addIndex}']`
    );
    if (!res) {
      slideListEl.value.prepend(getInsEl(props.list[addIndex], addIndex));
    }
  }
  let index = slideListEl.value
    .querySelector(`.${itemClassName}:last-child`)
    .getAttribute("data-index");
  appInsMap.get(Number(index)).unmount();

  slideListEl.value.querySelectorAll(`.${itemClassName}`).forEach((item) => {
    _css(item, "top", (state.localIndex - half) * state.wrapper.height);
  });
}
```

## å…¶ä»–é—®é¢˜

### ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ `v-for`ç›´æ¥ç”Ÿæˆ `SlideItem` å‘¢?

å¦‚æœå†…å®¹ä¸æ˜¯è§†é¢‘å°±å¯ä»¥ã€‚è¦åˆ é™¤æˆ–è€…æ–°å¢æ—¶ï¼Œç›´æ¥æ“ä½œ `list` æ•°æ®æºï¼Œè¿™æ ·çœäº‹å¤šäº†

å¦‚æœå†…å®¹æ˜¯è§†é¢‘ï¼Œä¿®æ”¹ `list` æ—¶ï¼Œ`Vue` ä¼šå¿«é€Ÿçš„æ›¿æ¢ `dom`ï¼Œæ­£åœ¨æ’­æ”¾çš„è§†é¢‘ï¼Œçªç„¶ä¸€ä¸‹ä»å¤´å¼€å§‹æ’­æ”¾äº† ğŸ˜…ğŸ˜…ğŸ˜…

### å¦‚ä½•è·å– `Vue` ç»„ä»¶çš„æœ€ç»ˆ `dom`

æœ‰ä¸¤ç§æ–¹å¼ï¼Œå„æœ‰åˆ©å¼Š

- ç”¨ `Vue` çš„ `render` æ–¹æ³•
  - ä¼˜ç‚¹ï¼šåªæ˜¯æ¸²æŸ“ä¸€ä¸ª `VNode` è€Œå·²ï¼Œç†è®ºä¸Šè®²å†…å­˜æ¶ˆè€—æ›´å°‘ã€‚
  - ç¼ºç‚¹ï¼šä½†æˆ‘åœ¨å¼€å‘ä¸­ï¼Œç”¨äº†è¿™ä¸ªæ–¹æ³•ï¼Œä»»ä½•ä¿®æ”¹éƒ½ä¼šåˆ·æ–°é¡µé¢ï¼Œæœ‰ç‚¹éš¾èšŒ ğŸ˜…
- ç”¨ `Vue` çš„ `createApp` æ–¹æ³•å†åˆ›å»ºä¸€ä¸ª `Vue` çš„å®ä¾‹
  - å’Œä¸Šé¢ç›¸å ğŸ˜…

```js
import {
  createApp,
  onMounted,
  reactive,
  ref,
  render as vueRender,
  watch,
} from "vue";

/**
 * è·å–Vueç»„ä»¶æ¸²æŸ“ä¹‹åçš„domå…ƒç´ 
 * @param item
 * @param index
 * @param play
 */
function getInsEl(item, index, play = false) {
  // console.log('index', cloneDeep(item), index, play)
  let slideVNode = props.render(item, index, play, props.uniqueId);
  const parent = document.createElement("div");
  //TODO æ‰“åŒ…åˆ°çº¿ä¸Šæ—¶ç”¨è¿™ä¸ªï¼Œè¿™ä¸ªåœ¨å¼€å‘æ—¶ä»»ä½•ä¿®æ”¹éƒ½ä¼šåˆ·æ–°é¡µé¢
  if (import.meta.env.PROD) {
    parent.classList.add("slide-item");
    parent.setAttribute("data-index", index);
    //å°†Vueç»„ä»¶æ¸²æŸ“åˆ°ä¸€ä¸ªdivä¸Š
    vueRender(slideVNode, parent);
    appInsMap.set(index, {
      unmount: () => {
        vueRender(null, parent);
        parent.remove();
      },
    });
    return parent;
  } else {
    //åˆ›å»ºä¸€ä¸ªæ–°çš„Vueå®ä¾‹ï¼Œå¹¶æŒ‚è½½åˆ°ä¸€ä¸ªdivä¸Š
    const app = createApp({
      render() {
        return <SlideItem data-index={index}>{slideVNode}</SlideItem>;
      },
    });
    const ins = app.mount(parent);
    appInsMap.set(index, app);
    return ins.$el;
  }
}
```
